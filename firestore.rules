rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------
    // HELPERS
    // -----------------------
    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    function myEmailLower() {
      return signedIn() && request.auth.token.email != null
        ? request.auth.token.email.lower()
        : "";
    }

    function leaguePath(leagueId) {
      return /databases/$(database)/documents/Leagues/$(leagueId);
    }

    function memberPath(leagueId, userId) {
      return /databases/$(database)/documents/Leagues/$(leagueId)/members/$(userId);
    }

    function rolePath(leagueId, roleId) {
      return /databases/$(database)/documents/Leagues/$(leagueId)/roles/$(roleId);
    }

    function userPath(userId) {
      return /databases/$(database)/documents/Users/$(userId);
    }

    function isMember(leagueId) {
      return signedIn() && exists(memberPath(leagueId, uid()));
    }

    function isCreator(leagueId) {
      return signedIn() && get(leaguePath(leagueId)).data.createdByUid == uid();
    }

    function myMemberData(leagueId) {
      return get(memberPath(leagueId, uid())).data;
    }

    function myRoleId(leagueId) {
      return isMember(leagueId)
        && myMemberData(leagueId).roleId != null
        ? myMemberData(leagueId).roleId
        : "";
    }

    function hasRolePerm(leagueId, permKey) {
      return isMember(leagueId)
        && myRoleId(leagueId) != ""
        && exists(rolePath(leagueId, myRoleId(leagueId)))
        && (get(rolePath(leagueId, myRoleId(leagueId))).data.permissions is map)
        && get(rolePath(leagueId, myRoleId(leagueId))).data.permissions[permKey] == true;
    }

    function canManageMembers(leagueId) {
      return isCreator(leagueId) || hasRolePerm(leagueId, "members_manage");
    }

    function canManageInvites(leagueId) {
      return isCreator(leagueId) || hasRolePerm(leagueId, "invites_manage");
    }

    function canManageRoles(leagueId) {
      return isCreator(leagueId) || hasRolePerm(leagueId, "roles_manage");
    }

    function canReadSensitive(leagueId) {
      return isCreator(leagueId) || hasRolePerm(leagueId, "members_sensitive_read");
    }

    function myCompartoLower(leagueId) {
      return isMember(leagueId) && myMemberData(leagueId).compartoLower != null
        ? myMemberData(leagueId).compartoLower
        : "";
    }

    // =====================================================
// USERS (PRIVATO) — SOLO SERVER
// =====================================================
match /Users/{userId} {

  allow read: if signedIn() && uid() == userId;

  // ❌ il client NON può più scrivere nulla
  allow create, update, delete: if false;

  match /sharedTo/{viewerUid} {
    allow read: if signedIn() && (uid() == userId || uid() == viewerUid);
    allow write: if false;
  }

  match /sharedToEmails/{emailLower} {
    allow read: if signedIn() && (uid() == userId || myEmailLower() == emailLower);
    allow write: if false;
  }

  match /sharedToLeagues/{leagueId} {
    allow read: if signedIn() && (uid() == userId || exists(memberPath(leagueId, uid())));
    allow write: if false;
  }

  match /fcmTokens/{tokenId} {
    allow read: if false;
    allow write: if signedIn() && uid() == userId;
  }
}


    // =====================================================
    // USERSPUBLIC — SOLO READ
    // =====================================================
    match /UsersPublic/{userId} {
      allow read: if signedIn();
      allow write: if false;

      match /{document=**} {
        allow read, write: if false;
      }
    }

    // =====================================================
    // NICKNAMES — SOLO BACKEND
    // =====================================================
    match /Nicknames/{nicknameLower} {
      allow read, write: if false;
    }

    // =====================================================
    // LEAGUES
    // =====================================================
    match /Leagues/{leagueId} {

      allow read: if signedIn() && (isMember(leagueId) || isCreator(leagueId));
      allow create, update, delete: if false;

      // MEMBERS — SOLO FUNCTION
      match /members/{memberUid} {
        allow read: if signedIn() && (isMember(leagueId) || isCreator(leagueId));
        allow write: if false;
      }

      // PROFILE FIELD DEFINITIONS
      match /profileFieldDefs/{fieldId} {
        allow read: if signedIn() && (isMember(leagueId) || isCreator(leagueId));
        allow write: if signedIn() && canManageMembers(leagueId);
      }

      // SHARE PREFERENCES (debug)
      match /sharePreferences/{prefUid} {
        allow read: if signedIn()
          && (uid() == prefUid || canManageMembers(leagueId));
        allow write: if false;
      }

      // sharedProfilesAll — LEAGUE
      match /sharedProfilesAll/{profileUid} {
        allow read: if signedIn() && (isMember(leagueId) || isCreator(leagueId));
        allow write: if false;
      }

      // sharedProfilesTargets — EMAIL / UID
      match /sharedProfilesTargets/{profileUid} {
        allow read: if signedIn() && (
          uid() == profileUid
          || isCreator(leagueId)
          || (
            isMember(leagueId)
            && (
              (resource.data.allowedUids is list
                && resource.data.allowedUids.hasAny([uid()]))
              || (resource.data.allowedEmailsLower is list
                && resource.data.allowedEmailsLower.hasAny([myEmailLower()]))
            )
          )
        );
        allow write: if false;
      }

      // sharedProfilesComparto
      match /sharedProfilesComparto/{profileUid} {
        allow read: if signedIn() && (
          uid() == profileUid
          || isCreator(leagueId)
          || (
            isMember(leagueId)
            && resource.data.allowSameComparto == true
            && myCompartoLower(leagueId) != ""
            && myCompartoLower(leagueId)
               == (resource.data.ownerCompartoLower != null
                   ? resource.data.ownerCompartoLower
                   : "")
          )
        );
        allow write: if false;
      }

      // sharedProfilesSpecial
      match /sharedProfilesSpecial/{profileUid} {
        allow read: if signedIn() && (
          uid() == profileUid
          || isCreator(leagueId)
          || (isMember(leagueId)
              && resource.data.allowSpecial == true
              && canReadSensitive(leagueId))
        );
        allow write: if false;
      }

      // sharedProfilesOwner
      match /sharedProfilesOwner/{profileUid} {
        allow read: if signedIn() && (
          uid() == profileUid
          || isCreator(leagueId)
        );
        allow write: if false;
      }

      // INVITES
      match /invites/{inviteId} {
        allow read: if signedIn() && (
          canManageInvites(leagueId)
          || resource.data.emailLower == myEmailLower()
          || resource.data.toEmailLower == myEmailLower()
        );
        allow create, update, delete: if signedIn() && canManageInvites(leagueId);
      }

      // JOIN REQUESTS
      match /joinRequests/{requestId} {
        allow create: if signedIn() && uid() == requestId;
        allow read: if signedIn()
          && (uid() == requestId || canManageMembers(leagueId));
        allow update, delete: if signedIn() && isCreator(leagueId);
      }

      // ROLES
      match /roles/{roleId} {
        allow read: if signedIn() && (isMember(leagueId) || isCreator(leagueId));
        allow create, update, delete: if signedIn() && canManageRoles(leagueId);
      }
    }
  }
}
